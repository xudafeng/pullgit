#!/usr/bin/env node

'use strict';

const fs = require('fs');
const _ = require('xutil');
const path = require('path');
const child_process = require('child_process');

const {
  chalk
} = _;

const rootDir = process.cwd();

console.log(`walk from: ${chalk.cyan(rootDir)}`);

const isGitProject = (directory) => {
  const gitPath = path.join(directory, '.git');
  return _.isExistedDir(gitPath);
};

const traversal = root => {
  const list = fs.readdirSync(root);
  list.forEach(item => {
    const dist = path.join(root, item);
    if (isGitProject(dist)) {
      try {
        console.log(`git pull ${chalk.green(dist)}`);
        const out = child_process.spawnSync('git', ['pull'], {
          cwd: dist
        });
        console.log(`${chalk.yellow(out.stdout.toString().trim())}`);
      } catch (e) {
        console.log(e);
      }
    } else if (_.isExistedDir(dist)) {
      traversal(dist);
    } else {
      console.log(`skip ${chalk.red(dist)}`);
    }
  });
};

traversal(rootDir);
